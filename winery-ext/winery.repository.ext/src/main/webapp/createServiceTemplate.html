<!--


    Copyright (C) 2016 ZTE, Inc. and others. All rights reserved. (ZTE)

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->

<html>
  <head>
    <meta charset="UTF-8">
    <title>Create Service</title>
    
    <script src="./components/jquery/jquery.min.js"></script>
    <script src="./components/jquery-validation/jquery.validate.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/main.css">
   
</head>
    <body>
    <div class="main">
        <div class="mainContent">   
            <div  class="addDevSer-header">
                <span>创建<lable class="serviceType">网络功能模板</lable></span>
            </div>
            <div  class="addDevSer-content">
                <form  id="serviceForm" role="form"> 
                    <input type="hidden" value="" name="namespace" id="namespace">
                    <div class="form-item">
                        <div class="control-label">
                            <span  class="name">基础类型：</span>
                        </div>
                        <select class="form-control m-b" id="inheritNodetypeSelect"></select>  
                    </div>
                    <div class="form-item">
                        <div class="control-label">
                            <span class="required" aria-required="true">*</span><span  class="name">名称：</span>
                        </div>                      
                        <input  maxlength="50" type="text" class="form-control" name="name" id="name"/>
                        <!-- <label class="nameHints">"0-9" "a-z" "A-Z" 开头和结尾只能是字母或者数字</label> -->
                    </div>

                    <div class="form-item">
                        <div class="control-label">
                            <span  class="name">nodeType：</span>
                        </div>
                        <input maxlength="50" class="form-control" type="text" value="" name="nodetype" id="nodetype" />
                    </div>
                      
                    <div class="button">
                        <button  class="zte-btn primary" id="saveBtn">创建</button>
                        <button  class="zte-btn no-primary" id="cancelBtn"  onclick="javascript:history.go(-1)">取消</button>
                    </div>
                </form>
            </div> <!-- end div addDevSer-header -->
        </div><!-- end div mainContent -->
    </div><!-- end div main -->

    <script>
    var serviceType = getQueryString("type");   
    var namespace;

    if(serviceType == null) serviceType="vnf";

    if(serviceType == "vnf"){
        $(".serviceType").text("网络功能模板");
        namespace = "http://www.zte.com.cn/tosca/nfv/vnf";
    } else{
        $(".serviceType").text("网络切片模板");
        namespace = "http://www.zte.com.cn/tosca/nfv/ns";
    }
    $("#namespace").val(namespace);

    $(function(){
        //初始化继承nodetype      
        $.ajax({
            "type": 'get',
            "url":  "/winery/nodetypes/",
            "dataType": "json",
            success: function (resp) {
                for(var i=0;i<resp.length;i++){
                    //创建vnf只能看到vnf的nodetype，创建ns只能看到ns的nodetype
                    if(resp[i].namespace == namespace) {
                        $("#inheritNodetypeSelect").append("<option value='" 
                            + resp[i].namespace + "'>" + resp[i].id + "</option>");
                    }
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert("获取继承nodetype信息失败：" + jqXHR.responseText); 
            },
            complete:function(){
                changeNodetype();
            }
        });

        $("#inheritNodetypeSelect").change(function(){ 
            changeNodetype();
        }); 

        //名称输入事件，同步名称到nodetype名称
        $("#name").keyup(function(){
            var name = $(this).val();
            var inheritNodetype = $("#inheritNodetypeSelect").find("option:selected").text()+".";
            var nodetypeName = inheritNodetype + name;
            $("#nodetype").val(nodetypeName);
        });

        $("#saveBtn").click(function(){
            $(this).addClass("disabled").attr("disabled", true);
            if (form.valid() == false) {
                $(this).removeClass("disabled").attr("disabled", false);
                return false;
            }

            if($("#nodetype").val() != ""){
                //nodetype格式效验
                var nodetype = $("#nodetype").val();                      
                var selectNodetype = $("#inheritNodetypeSelect").find("option:selected").text();

                if(nodetype.indexOf(selectNodetype) == -1){
                    alert("nodetype输入格式有误");
                    return false;
                }
            }

            var namespace_encode = encodeURIComponent(encodeURIComponent(namespace));
            var name = $("#name").val();

            //创建servicetemplates
            $.ajax({
                type: "POST",
                async: false,
                data: form.serialize(),
                url:"/winery/servicetemplates/",
                dataType: "text",
                error: function(jqXHR, textStatus, errorThrown) {                    
                    if(jqXHR.status == 409) {
                        alert("创建服务模板失败，该名称已存在。");
                    } else {
                        alert("创建服务模板失败:" + jqXHR.responseText);
                    }
                    $("#saveBtn").removeClass("disabled").attr("disabled", false);
                },
                success : function(resp) {  
                    var nodeTypeName = $("#nodetype").val();
                    if(nodeTypeName){
                        var nodeTypeObj = {
                            "namespace" : namespace,
                            "name" : nodeTypeName
                        }
                        //保存substitutableNodeType
                        saveSubstitutableNodeType(nodeTypeObj, namespace_encode, name);
                    } else {
                        $("#saveBtn").removeClass("disabled").attr("disabled", false);
                        window.location = "/winery/servicetemplates/" + namespace_encode
                            + "/" + name + "/topologytemplate/?edit";
                    }
                }
            });           
        });

        //保存substitutableNodeType
        function saveSubstitutableNodeType(nodeTypeObj, namespace_encode, name) {
            var substitutableNodeTypeUrl = "/winery/servicetemplates/"+namespace_encode
                    +"/"+name+"/substitutableNodeType";

            $.ajax({
                url : substitutableNodeTypeUrl,
                type : "POST",
                async: false,
                data : JSON.stringify(nodeTypeObj),
                contentType : "application/json",
                success : function(resp) {
                    //保存nodetype
                    createNodeType(nodeTypeObj, namespace_encode, name);
                },
                error: function(jqXHR, textStatus, errorThrown) {                   
                    alert("SubstitutableNodeType保存失败:" + jqXHR.responseText);
                    $("#saveBtn").removeClass("disabled").attr("disabled", false);
                }
            });
        }

        //保存nodetype
        function createNodeType(nodeTypeObj, namespace_encode, name) {
            $.ajax({
                type : "POST",
                async: false,
                url : "/winery/nodetypes/",
                data : $.param(nodeTypeObj),
                success : function(resp) {
                    //保存nodetype继承关系
                    saveNodeTypeDerivedFrom(namespace_encode, name);
                },
                error : function(jqXHR, textStatus, errorThrown) {
                    alert("NodeType保存失败:" + jqXHR.responseText);
                    $("#saveBtn").removeClass("disabled").attr("disabled", false);
                }
            });
        }

        //保存nodetype继承关系
        function saveNodeTypeDerivedFrom(namespace_encode, name) {
            var nodetype_namespace = $("#inheritNodetypeSelect").val(); 
            var selectNodetype = $("#inheritNodetypeSelect").find("option:selected").text();
            var derivedFromUrl = "/winery/nodetypes/" + namespace_encode + "/"
                    + $("#nodetype").val() + "/derivedFrom";
            var value = "{" + nodetype_namespace + "}" + selectNodetype;
            $.ajax({
                type: "PUT",
                async: false,
                url: derivedFromUrl,
                data: value,
                dataType: "text",
                processData: false, // leads to a send in the body
                error: function(jqXHR, textStatus, errorThrown) {
                    alert("NodeType继承关系设置失败:" + jqXHR.responseText);
                    $("#saveBtn").removeClass("disabled").attr("disabled", false);
                },
                success: function() {
                    console.log("Successfully updated " + derivedFromUrl);

                    //根据继承的nodetype属性，设置服务模板元数据
                    var nodetype_namespace_encode = encodeURIComponent(encodeURIComponent(nodetype_namespace));
                    setNodeTemplateMetaDataDerivedFromNodeType(nodetype_namespace_encode, selectNodetype, namespace_encode, name);
                    
                    window.location = "/winery/servicetemplates/" + namespace_encode
                        + "/" + name + "/topologytemplate/?edit";
                    $("#saveBtn").removeClass("disabled").attr("disabled", false);
                }
            });
        }

        //查询继承nodetype的属性，把这些属性设置到服务模板的metadata中去
        function setNodeTemplateMetaDataDerivedFromNodeType(nodeTypeNamespace, nodeTypeName,
            nodeTemplateNamespace, nodeTemplateName) {
            var queryNodeTypePropertiesURL = "/winery/nodetypes/"
                    + nodeTypeNamespace + "/" + nodeTypeName + "/propertiesdefinition/winery/list/";
            $.ajax({
                type : "GET",
                async: false,
                dataType : "json",
                url : queryNodeTypePropertiesURL,
                success : function(resp) {
                    resp = resp || [];
                    var metaData = {
                        metadatas : []
                    }
                    $.each(resp, function(index, property){
                        var data = {
                            key : property.key,
                            value : property.value,
                            tag : "inherit", //继承而来的属性
                            required : property.required //是否必填
                        }
                        metaData.metadatas.push(data);
                    });

                    var metaDataURL = "/winery/servicetemplates/" + nodeTemplateNamespace 
                            + "/" + nodeTemplateName + "/boundarydefinitions/properties/metadata/list";
                    addServiceTemplateMetaData(metaDataURL, metaData);
                }
            });
        }

        //给服务模板添加metadata信息
        function addServiceTemplateMetaData(metaDataURL, metaData) {
            $.ajax({
                url : metaDataURL,
                type : "POST",
                async : false,
                data : JSON.stringify(metaData),
                contentType : "application/json",
                success : function(resp) {
                  
                }
            });
        }
    });

    // jQuery.validator.addMethod("custom_content", function(value, element) {    
    //     return this.optional(element) ||  /^[0-9A-Za-z]+$/.test(value);    
    // }, "名称格式有误");

    var form = $('#serviceForm');
    var error = $('.alert-danger', form);
    var success = $('.alert-success', form);

    form.validate({
        doNotHideMessage: true, //this option enables to show the error/success messages on tab switch.
        errorElement: 'span', //default input error message container
        errorClass: 'help-block', // default input error message class
        focusInvalid: false, // do not focus the last invalid input
        rules: {          
            name:{
                required: true,
                //custom_content:true,
                maxlength:50
            },
            nodetype:{
                maxlength:50
            }
        },
        messages: {        
            name:{
                required: "请输入名称"
            }
        },
        errorPlacement: function (error, element) { // render error placement for each input type
            error.insertAfter(element); // for other inputs, just perform default behavior
        },
        invalidHandler: function (event, validator) { //display error alert on form submit   
            success.hide();
            error.show();
            //ZteFrameWork.scrollTo(error, -200);
        },
        highlight: function (element) { // hightlight error inputs
            $(element)
              .closest('.form-item').removeClass('has-success').addClass('has-error'); // set error class to the control group
        },
        unhighlight: function (element) { // revert the change done by hightlight
            $(element)
              .closest('.form-item').removeClass('has-error'); // set error class to the control group
        },
        success: function (label) {
            label
              .addClass('valid') // mark the current input as valid and display OK icon
              .closest('.form-itemp').removeClass('has-error'); // set success class to the control group
        },
        submitHandler: function (form) {
            success.show();
            error.hide();
            //add here some ajax code to submit your form or just call form.submit() if you want to submit the form without ajax
        }
    });

    function getQueryString(name) { 
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); 
        var r = window.location.search.substr(1).match(reg); 
        if (r != null) return unescape(r[2]); 
        return null; 
    } 

    function changeNodetype(){
        var selectText = $("#inheritNodetypeSelect").find("option:selected").text()+".";
        $("#nodetype").val(selectText);
    }
    </script>
    </body>
</html>
